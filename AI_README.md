# ðŸ¤– AI Context & Technical Deep Dive: Project Kodak

**Target Audience:** Large Language Models (LLMs) and Advanced Developers.
**Purpose:** Instant architectural alignment. Read this file to understand the "Soul" of the codebase before making changes.

---

## 1. Core Identity & Philosophy

**Project Kodak** is a local-first, privacy-focused, currency-agnostic investment portfolio tracker. 

*   **Pattern:** ELT (Extract, Load, Transform). We do NOT calculate state during ingestion. We ingest raw events into a ledger (`transactions` table) and calculate state (Holdings, XIRR) on-demand at runtime.
*   **Currency Agnosticism:** The system is built to support ANY base currency. Hardcoded currency strings (e.g., "NOK") are strictly forbidden in core logic. Always use `scripts.shared.utils.load_config()` to get `BASE_CURRENCY`.
*   **Truth Source:** 
    *   **Transactions Table:** The source of truth for *Settlement* (Cash flow).
    *   **Instruments Table:** The source of truth for *Asset Metadata* (Trading Currency, Sector).
*   **Parsing Strategy:** Parsers are "Translation Layers". They must normalize broker-specific oddities (e.g., localized headers, weird date formats) into our **Standard Schema**.

---

## 2. Data Flow Architecture

### Phase 1: Ingestion (Extract & Load)
1.  **Input:** User drops CSV/Excel into `data/new_raw_transactions/<broker_name>/`.
2.  **Detection:** `scripts/pipeline/ingest.py` scans folders and dynamically imports `scripts/pipeline/parsers/<broker_name>.py`.
3.  **Parsing:** The parser reads the file and returns a list of standardized dictionaries.
    *   *Constraint:* Must use `scripts.shared.parser_utils.create_empty_transaction()` to initialize dicts.
    *   *Constraint:* `amount` must be in **Asset Currency**. `amount_local` must be in **Base Currency**.
4.  **Deduplication:** A content hash is generated (`md5(date|account|type|symbol|amount)`). Duplicates are skipped.
5.  **Staging:** Valid rows are inserted into `transactions_staging`.
6.  **Review:** `scripts/pipeline/review_commit.py` shows the user new Accounts/Instruments.
7.  **Commit:** Data moves to the permanent `transactions` table. New Accounts default to `BASE_CURRENCY`.

### Phase 2: Enrichment (Transform)
1.  **Market Data:** `scripts/pipeline/fetch_prices.py` fetches EOD prices from Yahoo Finance for all instruments.
2.  **FX Rates:** `scripts/pipeline/enrich_fx.py` fills in missing exchange rates for historical transactions using Yahoo Finance history.

### Phase 3: Reporting (Output)
1.  **Calculation Engine:** `scripts/shared/calculations.py` is the "Brain".
    *   **`get_holdings()`**: Replays ledger to find current quantity.
    *   **`get_yearly_contribution()`**: Complex logic for XIRR and P&L attribution per asset per year.
    *   **`get_yearly_equity_curve()`**: Generates the main performance chart.
2.  **Dashboard:** Streamlit apps in `scripts/dashboard/` visualize this data.

---

## 3. The Standard Transaction Schema

Any `transactions` row MUST adhere to this logic:

| Column | Role | Rule |
| :--- | :--- | :--- |
| `date` | When | ISO 8601 String `YYYY-MM-DD`. |
| `type` | What | `BUY`, `SELL`, `DIVIDEND`, `DEPOSIT`, `WITHDRAWAL`, `INTEREST`, `FEE`, `TAX`, `TRANSFER_IN`, `TRANSFER_OUT`. |
| `quantity` | Scale | Positive for Long (Buy), Negative for Short (Sell). Absolute for others. |
| `amount` | **Asset Value** | The raw value in the **Trading Currency** (e.g., USD for Apple). |
| `currency` | **Asset Currency** | The currency code of the *Asset* (e.g., 'USD'). |
| `amount_local` | **Settlement** | The value in **Base Currency** (e.g., NOK). |
| `exchange_rate` | Bridge | `amount_local / amount`. Must be stored if available. |

**Critical "Auto-FX" Rule:** 
Some brokers (Nordnet/Saxo) settle foreign trades in the user's local currency.
*   **BAD:** Storing `currency='NOK'` and `amount=local_value`. (Undervalues asset in reporting).
*   **GOOD:** Parser must detect this, set `currency='USD'`, and back-calculate `amount = local / fx_rate`.

---

## 4. Key Calculation Logic & Gotchas

### 4.1. FX Fallback Strategy
When calculating historical value (e.g., "Value of Apple in 2021"), we need the USD/NOK rate for Dec 31, 2021.
1.  **Try Yahoo:** Fetch `USDNOK=X`.
2.  **Fallback (DB):** If Yahoo fails, query the `transactions` table for *any* transaction involving USD (or instruments trading in USD) around that date and use its stored `exchange_rate`.
    *   *Why?* Because Yahoo often lacks history for niche pairs, but the user's own trade history is a source of truth.

### 4.2. "Cash FX & Float"
This is a balancing figure in the Performance Report.
`Float = (End Equity - Start Equity - Net Deposits) - (Sum of Asset P&L)`
*   It represents returns generated by **Uninvested Cash** or **Margin Debt**.
*   *Example:* If you hold debt in USD and USD crashes, your debt shrinks. This is a "Float Profit".

### 4.3. Share Splits
Splits are detected via `BYTTE` (Exchange) transactions in the DB.
*   The system calculates a `split_map` dynamically.
*   Historical quantities are adjusted *on read* to match Yahoo's split-adjusted prices. We do *not* rewrite historical ledger quantities.

---

## 5. Developer Guide: Adding a New Parser

1.  **Create:** `scripts/pipeline/parsers/mybroker.py`.
2.  **Import:** `from scripts.shared.parser_utils import create_empty_transaction, clean_num`.
3.  **Config:** `from scripts.shared.utils import load_config; config = load_config(); BASE_CURRENCY = config.get('base_currency', 'NOK')`.
4.  **Implement:** `def parse(file_path) -> List[Dict]:`.
5.  **Verify:** Run `python -m scripts.maintenance.test_parser mybroker path/to/sample.csv`.

---

## 6. Directory Map

*   `scripts/shared/`: Reusable logic. `db.py` (SQLite), `market_data.py` (Yahoo), `calculations.py` (Math).
*   `scripts/pipeline/`: ETL jobs. `ingest.py`, `enrich_fx.py`.
*   `scripts/analysis/`: Terminal-based reports (CLI).
*   `scripts/dashboard/`: Streamlit Web UI.
*   `data/reference/`: `isin_map.csv` (Manual overrides for messy broker data).

---

## 7. Known "Dragons" (Past Bugs Fixed)

*   **Trustly Deposits:** Nordnet labeled them "OVERFÃ˜RING VIA TRUSTLY". We standardized them to "DEPOSIT" in the DB.
*   **The "HKD" Bug:** A foreign stock settled in NOK was recorded as `currency='NOK'`. This broke the valuation report because it didn't apply the FX multiplier. We fixed the Parser to force `currency='HKD'` and the Calculator to handle FX fallbacks smarter.
*   **Hardcoded NOK:** The codebase used to assume NOK everywhere. It is now fully dynamic via `config.yaml`. Do not re-introduce string literals for currencies.
